# ngrok Setup for Robinhood Connect Testing

## Why ngrok?

Robinhood's servers need to call your `/api/robinhood/redeem-deposit-address` endpoint to get your wallet address. Since `localhost:3030` isn't accessible from the internet, we need ngrok to create a public tunnel.

## Quick Start

### Step 1: Get ngrok Auth Token

1. Visit https://dashboard.ngrok.com/signup
2. Sign up for a free account
3. Copy your auth token from https://dashboard.ngrok.com/get-started/your-authtoken

### Step 2: Configure ngrok

```bash
# Add your auth token (do this once)
ngrok config add-authtoken YOUR_AUTH_TOKEN_HERE
```

### Step 3: Start ngrok Tunnel

```bash
# In a new terminal, start ngrok
ngrok http 3030
```

You'll see output like:

```
Session Status                online
Account                       Your Name (Plan: Free)
Version                       3.31.0
Region                        United States (us)
Latency                       -
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://abc123def456.ngrok-free.app -> http://localhost:3030

Connections                   ttl     opn     rt1     rt5     p50     p90
                              0       0       0.00    0.00    0.00    0.00
```

### Step 4: Update Your Environment Variables

Copy the `https://` URL from ngrok output and add it to your `.env.local`:

```bash
# In .env.local
APP_URL=https://abc123def456.ngrok-free.app
ROBINHOOD_API_KEY=your-api-key-here
ROBINHOOD_APP_ID=db2c834a-a740-4dfc-bbaf-06887558185f
```

### Step 5: Restart Your Dev Server

```bash
# Stop current server (Ctrl+C)
# Then restart
cd robinhood-offramp
npm run dev
```

## Testing the Setup

### 1. Verify ngrok is Working

```bash
# In another terminal, test if your callback endpoint is publicly accessible
curl https://abc123def456.ngrok-free.app/api/robinhood/redeem-deposit-address \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"referenceId":"test-123"}'

# Should get: {"success":false,"error":"Invalid referenceId format..."}
# This is GOOD - it means the endpoint is accessible!
```

### 2. View ngrok Dashboard

Open http://127.0.0.1:4040 in your browser to see:

- All incoming requests
- Request/response details
- Helpful for debugging Robinhood's callbacks

### 3. Test Full Flow

1. Go to http://localhost:3030/dashboard (or your ngrok URL)
2. Click "Give with Robinhood"
3. Complete the flow in Robinhood
4. Watch for incoming POST request to `/api/robinhood/redeem-deposit-address` in:
   - Your Next.js server logs
   - ngrok dashboard (http://127.0.0.1:4040)

## Important Notes

### Free Plan Limitations

- ✅ HTTPS tunnels (required for Robinhood)
- ✅ Unlimited requests
- ⚠️ URL changes each time you restart ngrok
- ⚠️ Sessions expire after 2 hours (restart ngrok)

### URL Changes

Every time you restart ngrok, you get a NEW URL like:

- First time: `https://abc123.ngrok-free.app`
- After restart: `https://xyz789.ngrok-free.app` (DIFFERENT!)

**Solution**: Update `APP_URL` in `.env.local` each time and restart your dev server.

### Static Subdomain (Paid Plan)

If you upgrade to ngrok Pro ($8/month), you can get a static subdomain:

```bash
ngrok http 3030 --subdomain=endaoment-robinhood
# Always: https://endaoment-robinhood.ngrok.io
```

## Workflow

### Terminal 1: Next.js Server

```bash
cd robinhood-offramp
npm run dev
# Runs on http://localhost:3030
```

### Terminal 2: ngrok Tunnel

```bash
ngrok http 3030
# Creates https://abc123.ngrok-free.app -> localhost:3030
```

### Terminal 3: Testing/Debugging

```bash
# Watch ngrok traffic
curl http://127.0.0.1:4040/api/requests

# Or open in browser
open http://127.0.0.1:4040
```

## Troubleshooting

### Issue: "ERR_NGROK_108"

**Problem**: Auth token not configured

**Solution**:

```bash
ngrok config add-authtoken YOUR_AUTH_TOKEN
```

### Issue: "Tunnel not found"

**Problem**: ngrok isn't running

**Solution**:

```bash
# Start ngrok in a separate terminal
ngrok http 3030
```

### Issue: "Connection refused"

**Problem**: Next.js server isn't running

**Solution**:

```bash
cd robinhood-offramp
npm run dev
```

### Issue: Callback not received

**Problem**: `APP_URL` doesn't match ngrok URL

**Check**:

1. ngrok shows: `https://abc123.ngrok-free.app`
2. `.env.local` has: `APP_URL=https://abc123.ngrok-free.app` ✅
3. Restart Next.js server after changing `.env.local`

### Issue: "Invalid API Key" in callback

**Problem**: Environment variables not loading

**Solution**:

```bash
# Check .env.local exists
cat robinhood-offramp/.env.local

# Should see:
# ROBINHOOD_API_KEY=...
# ROBINHOOD_APP_ID=...
# APP_URL=https://...

# Restart server
npm run dev
```

## What Success Looks Like

### 1. ngrok Terminal Shows:

```
HTTP Requests
-------------

POST /api/robinhood/redeem-deposit-address  200 OK
```

### 2. Next.js Logs Show:

```
POST /api/robinhood/redeem-deposit-address 200 in 150ms
📦 [ASSET] User selected: ETH on ETHEREUM
🏦 [WALLET] Using our wallet address:
   Address: 0xa22d566f52b303049d27a7169ed17a925b3fdb5e
```

### 3. Robinhood App Shows:

```
✅ Transfer initiated
Sending 0.5 ETH to 0xa22d566f52b303049d27a7169ed17a925b3fdb5e
```

## Alternative: Deploy to Vercel (Production)

If ngrok is too much hassle, deploy to Vercel:

```bash
# Install Vercel CLI
npm i -g vercel

# Deploy
cd robinhood-offramp
vercel

# Get your production URL
# Update Robinhood dashboard with: https://your-app.vercel.app/api/robinhood/redeem-deposit-address
```

## Security Note

⚠️ ngrok URLs are public and accessible by anyone who knows the URL. Don't share your ngrok URL publicly. For production, use a proper deployment with:

- Rate limiting
- IP whitelisting (Robinhood's IPs only)
- API key validation
- Request logging

---

**Ready?** Once you have your ngrok auth token:

```bash
# 1. Configure ngrok
ngrok config add-authtoken YOUR_TOKEN

# 2. Start ngrok
ngrok http 3030

# 3. Copy the https URL

# 4. Update .env.local
echo "APP_URL=https://your-ngrok-url.ngrok-free.app" >> robinhood-offramp/.env.local

# 5. Restart Next.js
cd robinhood-offramp && npm run dev
```

Happy testing! 🚀
