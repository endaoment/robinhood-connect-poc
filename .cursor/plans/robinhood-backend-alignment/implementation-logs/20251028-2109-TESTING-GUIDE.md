# Order Details API - Testing Guide

**Date**: 2025-10-28
**Status**: ğŸŸ¢ READY FOR TESTING

## âœ… What's Been Changed

The callback page now uses the **Order Details API** to get complete transfer information instead of relying on URL parameters.

### Files Changed:
```
app/(routes)/callback/page.tsx  â†’ Renamed to page-old.tsx (backup)
app/(routes)/callback/page-new.tsx â†’ Renamed to page.tsx (NOW ACTIVE)
```

## ğŸ§ª How to Test

### Step 1: Start the Application
```bash
cd /Users/rheeger/Code/endaoment/robinhood-connect-poc/robinhood-onramp
npm run dev
```

### Step 2: Initiate a Transfer
1. Navigate to `http://localhost:3000`
2. Select an asset (e.g., SOL, BTC, ETH)
3. Click "Generate Onramp URL"
4. Click "Open Robinhood Connect"

### Step 3: Complete Transfer in Robinhood
1. Robinhood UI will open
2. Complete the transfer (can use a small amount for testing)
3. Robinhood will redirect back to your callback page

### Step 4: Observe the New Callback Flow

#### What You Should See:

**1. Loading State (2-10 seconds)**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ Processing Transfer             â”‚
â”‚  Fetching transfer details from     â”‚
â”‚  Robinhood...                       â”‚
â”‚                                     â”‚
â”‚  Please wait                        â”‚
â”‚  Attempt 1 of 10                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. Success State**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Transfer Complete!              â”‚
â”‚                                     â”‚
â”‚  Asset: SOL                         â”‚
â”‚  Amount: 0.002 SOL                  â”‚
â”‚  Value (USD): $0.41                 â”‚
â”‚  Network: SOLANA                    â”‚
â”‚  Status: SUCCEEDED                  â”‚
â”‚                                     â”‚
â”‚  Transaction Hash:                  â”‚
â”‚  4bED2xdo6sjGWaqF...                â”‚
â”‚                                     â”‚
â”‚  âœ… Pledge Created                  â”‚
â”‚  Your donation has been recorded    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. Browser Console Logs**

Open the browser console (F12) and look for:
```
ğŸ” [CALLBACK] Fetching order details for connectId: 596e6a8d-...
ğŸ“Š [CALLBACK] Order details received: {
  status: "ORDER_STATUS_SUCCEEDED",
  assetCode: "SOL",
  cryptoAmount: "0.002",
  fiatAmount: "0.41"
}
âœ… [CALLBACK] Order completed successfully
ğŸ“ [CALLBACK] Creating pledge from order details...
âœ… [CALLBACK] Pledge created successfully
```

**4. Server Console Logs**

In your terminal where `npm run dev` is running:
```
ğŸ” [ORDER-DETAILS] Starting request
âœ“ [VALIDATION] connectId: 596e6a8d-3ccd-47f2-b392-7de79df3e8d1
ğŸŒ [API] Fetching order details from Robinhood...
âœ… [API] Order details retrieved successfully
ğŸ“Š [DETAILS] {
  assetCode: 'SOL',
  cryptoAmount: '0.002',
  fiatAmount: '0.41',
  status: 'ORDER_STATUS_SUCCEEDED',
  blockchainTxId: '4bED2xdo6sjG...'
}
â±ï¸ [TIMING] Request completed in 234ms
```

## ğŸ¯ What to Verify

### âœ… Data Accuracy Checklist:

- [ ] **Crypto Amount**: Matches what you transferred
- [ ] **Fiat Amount**: USD value looks correct
- [ ] **Asset Code**: Correct asset (SOL/BTC/ETH/etc)
- [ ] **Network Code**: Correct network (SOLANA/BITCOIN/ETHEREUM/etc)
- [ ] **Blockchain TX Hash**: Present and looks valid
- [ ] **Destination Address**: Your wallet address shown
- [ ] **Status**: Shows "SUCCEEDED"
- [ ] **Pledge Created Toast**: Green success toast appears
- [ ] **No Errors**: No red error messages

### âœ… Functional Checklist:

- [ ] **Polling Works**: Loading screen appears briefly
- [ ] **Auto-Creation**: Pledge creates automatically (no manual action needed)
- [ ] **UI Updates**: Smooth transition from loading â†’ success
- [ ] **Transaction Hash Copyable**: Can copy blockchain tx hash
- [ ] **Navigation Works**: "View Dashboard" and "Make Another Donation" buttons work

## ğŸ› Potential Issues to Watch For

### Issue 1: Order Still Processing
**Symptom**: Loading screen keeps retrying (Attempt 2, 3, 4...)
**Cause**: Transfer not yet complete on blockchain
**Expected Behavior**: Should succeed within 10 attempts (20 seconds)
**Action**: If it takes longer than 20 seconds, check Robinhood UI for transfer status

### Issue 2: 404 Not Found
**Symptom**: Error message "Failed to fetch order details"
**Cause**: connectId not recognized by Robinhood API
**Check**: Console logs for the actual connectId being used
**Action**: Verify the connectId in the callback URL matches a real transfer

### Issue 3: Pledge Creation Fails
**Symptom**: Transfer details shown but "Pledge Creation Failed" toast
**Cause**: Backend mock service issue or token not found
**Check**: Browser console for detailed error message
**Action**: Check if asset/network combination exists in mock token service

### Issue 4: Amount Shows as 0
**Symptom**: Order details show but cryptoAmount or fiatAmount is "0"
**Cause**: Transfer might not have included an amount (cancelled?)
**Check**: Robinhood UI - was the transfer actually completed?
**Action**: Verify in Robinhood that the transfer went through

## ğŸ“Š Expected API Response

When polling the Order Details API, you should get:

```json
{
  "success": true,
  "data": {
    "applicationId": "db2c834a-a740-4dfc-bbaf-06887558185f",
    "connectId": "596e6a8d-3ccd-47f2-b392-7de79df3e8d1",
    "assetCode": "SOL",
    "networkCode": "SOLANA",
    "fiatCode": "USD",
    "fiatAmount": "0.41",
    "cryptoAmount": "0.002",
    "networkFee": {
      "type": "PRICE_ITEM_TYPE_CRYPTO_CURRENCY_NETWORK_FEE",
      "fiatAmount": "0.05",
      "cryptoQuantity": "0.0002"
    },
    "paymentMethod": "crypto_balance",
    "totalAmount": {
      "type": "PRICE_ITEM_TYPE_TOTAL",
      "fiatAmount": "0.46",
      "cryptoQuantity": "0.0022"
    },
    "blockchainTransactionId": "4bED2xdo6sjGWaqF1VaFGXdzYWuasg1pKQi1x1wSzhKErDbDujoFggLSFkTMuAT72uy5nXPtoSMCahLrsTuXhahz",
    "destinationAddress": "DPsUYCziRFjW8dcvitvtrJJfxbPUb1X7Ty8ybn3hRwM1",
    "status": "ORDER_STATUS_SUCCEEDED"
  }
}
```

## ğŸ”§ Debugging Tools

### Manual API Test:
If you want to test the API directly with a known connectId:

```bash
# Get environment variables
export $(cat .env.local | grep -v '^#' | xargs)

# Test with your connectId
npx tsx scripts/test-order-details-api.ts <YOUR_CONNECT_ID>

# Example (using the test connectId):
npx tsx scripts/test-order-details-api.ts 596e6a8d-3ccd-47f2-b392-7de79df3e8d1
```

### Browser API Test:
```javascript
// In browser console while on localhost:3000
const connectId = '596e6a8d-3ccd-47f2-b392-7de79df3e8d1'
const response = await fetch(`/api/robinhood/order-details?connectId=${connectId}`)
const data = await response.json()
console.log(data)
```

## ğŸ“ What to Report Back

After testing, please report:

### âœ… If Successful:
- "âœ… Test passed! Amounts matched, pledge created, blockchain tx hash captured"
- Include: Asset, amount, fiat value from the UI
- Screenshot of success screen (optional)

### âŒ If Failed:
- Error message shown in UI
- Browser console logs (copy/paste or screenshot)
- Server console logs (copy/paste)
- What step it failed at (polling/pledge creation/display)
- connectId from the callback URL

## ğŸ¯ Success Criteria

The test is successful if:
1. âœ… Callback page loads and starts polling
2. âœ… Order Details API returns complete data
3. âœ… Amounts (crypto + fiat) are displayed correctly
4. âœ… Blockchain transaction hash is shown
5. âœ… Pledge is created automatically
6. âœ… Success toast appears
7. âœ… No errors in console

---

**Ready to test!** Make a small transfer and let me know what happens! ğŸš€

