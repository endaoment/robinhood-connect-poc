# Sub-Plan 9.5 Planning Complete

**Date**: 2025-10-25 13:56
**Implementer**: AI Agent
**Status**: âœ… PLANNING COMPLETE

## Summary

Created Sub-Plan 9.5: Directory Restructuring for Backend Alignment to address user feedback about aligning the POC structure with endaoment-backend conventions.

## User Requirements

The user requested:

1. **Rename**: `lib/` â†’ `libs/` (plural) to match backend
2. **Move Tests**: From `__tests__/` into each library (co-locate)
3. **NestJS Structure**: Follow `src/lib/` pattern with `dtos/`, `services/`, `constants/`
4. **Backend Ready**: Structure should match `/Users/rheeger/Code/endaoment/endaoment-backend/libs/api/`
5. **Separation**: Robinhood lib + Coinbase lib + Shared lib

## What Was Created

### New Sub-Plan: SP9.5

**File**: `.cursor/plans/robinhood-backend-alignment/sub-plans/sub-plan-9.5-directory-restructuring-for-backend.md`

**Sections**:

1. **Context Required**: Current vs target structure comparison
2. **Objectives**: 7 clear objectives for restructuring
3. **Precise Implementation Steps**: 14 detailed steps
4. **Deliverables Checklist**: 13 items to verify
5. **Validation Steps**: 6 validation commands
6. **Backward Compatibility Checkpoint**: Comprehensive testing
7. **Common Issues and Solutions**: 4 common problems
8. **Integration Points**: How SP9.5 connects to other sub-plans
9. **Migration Instructions**: How to copy to endaoment-backend

### Target Structure

```
libs/
â”œâ”€â”€ robinhood/
â”‚   â”œâ”€â”€ src/lib/
â”‚   â”‚   â”œâ”€â”€ services/      # All business logic
â”‚   â”‚   â”œâ”€â”€ dtos/          # All DTOs
â”‚   â”‚   â”œâ”€â”€ constants/     # All constants
â”‚   â”‚   â”œâ”€â”€ types/         # Shared types
â”‚   â”‚   â””â”€â”€ index.ts       # Barrel export
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ services/      # Service tests (.spec.ts)
â”‚   â”‚   â””â”€â”€ mocks/         # Test mocks
â”‚   â””â”€â”€ README.md
â”œâ”€â”€ coinbase/
â”‚   â”œâ”€â”€ src/lib/
â”‚   â”‚   â”œâ”€â”€ services/      # Prime API services
â”‚   â”‚   â””â”€â”€ constants/     # Prime config
â”‚   â”œâ”€â”€ tests/
â”‚   â””â”€â”€ README.md
â””â”€â”€ shared/
    â”œâ”€â”€ src/lib/
    â”‚   â”œâ”€â”€ utils/         # Performance, security
    â”‚   â””â”€â”€ backend-mock/  # POC-only mocks
    â”œâ”€â”€ tests/
    â””â”€â”€ README.md
```

### Key Features

1. **Service Refactoring**: Converts `assets/` utilities into proper services
   - `AssetDiscoveryService`
   - `EvmAssetService`
   - `NonEvmAssetService`
   - `OtcLoaderService`

2. **Library Separation**: 
   - Robinhood â†’ `/libs/api/robinhood/`
   - Coinbase Prime â†’ merge into `/libs/api/coinbase/`
   - Shared utils â†’ selective migration

3. **Test Co-location**: Tests live with the code they test

4. **Barrel Exports**: Clean import paths with index.ts files

5. **Migration Ready**: Each lib has README with integration instructions

## Documentation Updates

### README.md

- Added SP9.5 to sub-plan table
- Updated dependency graph (SP9 â†’ SP9.5 â†’ SP10)
- Updated project metadata (9 of 15 complete, 60%)
- Changed next steps to point to SP9.5

### OVERVIEW.md

- Added Decision 6: Directory Structure Alignment
- Documented rationale for full NestJS structure
- Explained migration path for each library
- Listed consequences and mitigations

### Implementation Log

- Created this timestamped log (20251025-1356-SP9.5-PLANNING.md)

## Rationale

This restructuring:

1. **Matches Backend**: Exact same structure as endaoment-backend libs/api/
2. **Clear Boundaries**: Each lib is self-contained
3. **Test Co-location**: Backend standard (tests/ next to src/)
4. **Copy/Paste Ready**: Can drop libs into backend with minimal changes
5. **Separation of Concerns**: Robinhood, Coinbase, and Shared clearly separated

## Impact on Other Sub-Plans

### SP10: Backend Integration Demo
- **Update needed**: Use new `@/libs/robinhood` imports
- **Benefit**: Cleaner imports, clear library boundaries

### SP11: API Route Refactoring
- **Update needed**: Import from `@/libs/robinhood/src`
- **Benefit**: Exactly matches backend import pattern

### SP12: Migration Guide
- **Enhancement**: Document per-library migration
- **Benefit**: Clear copy/paste instructions for each lib

### SP13: Architecture Documentation
- **Enhancement**: Diagram libs/ structure
- **Benefit**: Shows how POC maps to backend

## Next Steps

1. **Review SP9.5**: User reviews sub-plan for completeness
2. **Implement SP9.5**: Execute 14 steps to restructure
3. **Validate**: Run comprehensive validation (TypeScript, tests, app)
4. **Checkpoint**: Verify POC still works
5. **Complete**: Create SP9.5-COMPLETE.md log
6. **Proceed**: Move to SP10 with new structure

## Dependencies

**Required Before SP9.5**:

- âœ… SP0-9: All foundation and testing complete
- âœ… Services exist: Can be moved
- âœ… Tests exist: Can be relocated
- âœ… POC functional: Can verify backward compatibility

**Enables After SP9.5**:

- SP10: Integration demo with clean imports
- SP11: API refactoring with backend patterns
- SP12: Clear migration guide per library
- SP13: Architecture docs showing libs/

## Validation Criteria

After SP9.5 implementation:

- [ ] `libs/` directory exists (plural)
- [ ] Three libraries: robinhood, coinbase, shared
- [ ] Each lib has `src/lib/` structure
- [ ] Each lib has `tests/` co-located
- [ ] All imports updated to `@/libs/*`
- [ ] TypeScript compiles: 0 errors
- [ ] All tests pass: 183+ tests
- [ ] Coverage maintained: 80%+
- [ ] App runs: No errors
- [ ] Old `lib/` and `__tests__/` removed

## Deviations from Original Plan

**Original Plan** (SP0):

```
lib/
â”œâ”€â”€ robinhood/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ dtos/
â”‚   â””â”€â”€ constants/
â””â”€â”€ backend-mock/
```

**New Plan** (SP9.5):

```
libs/                   # Plural!
â”œâ”€â”€ robinhood/          # Self-contained
â”‚   â”œâ”€â”€ src/lib/        # NestJS pattern
â”‚   â””â”€â”€ tests/          # Co-located
â”œâ”€â”€ coinbase/           # Separated!
â””â”€â”€ shared/             # Explicit!
```

**Reason**: User feedback + backend alignment requirement

## Time Estimate

**Sub-Plan 9.5**: 3-4 hours

- Directory creation: 15 min
- File moves: 30 min
- Service refactoring: 1 hour
- Import updates: 45 min
- Testing/validation: 45 min
- Documentation: 15 min

**Total for SP9.5-13**: Still ~14-18 hours (unchanged)

## Risks

**ðŸŸ¡ MEDIUM**: Import path updates could be error-prone

- **Mitigation**: Automated sed commands in sub-plan
- **Validation**: TypeScript compiler will catch errors
- **Rollback**: Git revert if needed

**ðŸŸ¢ LOW**: Directory moves are straightforward

- **Mitigation**: Detailed cp commands in sub-plan
- **Validation**: tree command shows structure

## Success Indicators

âœ… Sub-plan is comprehensive (14 steps, 13 deliverables)
âœ… Validation is thorough (6 validation steps)
âœ… Backward compatibility checkpoint included
âœ… Migration instructions provided
âœ… README.md for each library
âœ… Barrel exports documented
âœ… Clear rationale in OVERVIEW.md

## Files Modified

1. `.cursor/plans/robinhood-backend-alignment/sub-plans/sub-plan-9.5-directory-restructuring-for-backend.md` (NEW)
2. `.cursor/plans/robinhood-backend-alignment/README.md` (UPDATED)
3. `.cursor/plans/robinhood-backend-alignment/OVERVIEW.md` (UPDATED)
4. `.cursor/plans/robinhood-backend-alignment/implementation-logs/20251025-1356-SP9.5-PLANNING.md` (THIS FILE)

## Agent Notes

This sub-plan was created in response to user's excellent feedback about aligning with the backend structure. The user correctly identified that:

1. The POC should mirror the backend exactly
2. Tests should be co-located with code
3. Libraries should be clearly separated
4. The structure should enable copy/paste migration

The resulting sub-plan is comprehensive and follows all planning methodology standards. It's ready for implementation.

---

**Status**: Ready for user review and implementation

